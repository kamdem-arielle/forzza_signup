<div class="agents-container">
  <div class="page-header">
    <h2>{{ 'adminNav.agents' | translate }}</h2>
    <p class="page-subtitle">{{ 'adminAgents.subtitle' | translate }}</p>
  </div>

  <div *ngIf="message" class="message" [class.success]="isSuccess" [class.error]="!isSuccess">
    {{ message }}
  </div>

  <!-- Admin Filter (SuperAdmin only) -->
  <div class="filter-bar" *ngIf="isSuperAdmin">
    <div class="filter-group">
      <label>{{ 'filters.admin' | translate }}</label>
      <select class="styled-select" [(ngModel)]="selectedAdminId" (ngModelChange)="onAdminFilterChange()">
        <option [ngValue]="null">{{ 'filters.allAdmins' | translate }}</option>
        <option *ngFor="let admin of admins" [ngValue]="admin.id">{{ admin.username }}</option>
      </select>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="stats-cards" *ngIf="!isLoading">
    <!-- Total Agents Card -->
    <div class="stat-card">
      <div class="stat-header">
        <div class="stat-icon agents-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
          </svg>
        </div>
        <span class="stat-label">{{ selectedAdminLabel }}</span>
      </div>
      <div class="stat-value">{{ stats.totalAgents }}</div>
      <div class="stat-title">{{ 'adminAgents.stats.totalAgents' | translate }}</div>
      <div class="stat-change" [class.positive]="stats.agentChangePercent >= 0" [class.negative]="stats.agentChangePercent < 0">
        <span *ngIf="stats.agentChangePercent >= 0">+</span>{{ stats.agentChangePercent }}% {{ 'adminAgents.stats.fromLastMonth' | translate }}
      </div>
    </div>

    <!-- Total Registrations Card -->
    <div class="stat-card">
      <div class="stat-header">
        <div class="stat-icon registrations-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
            <polyline points="17 6 23 6 23 12"></polyline>
          </svg>
        </div>
        <span class="stat-label">{{ selectedAdminLabel }}</span>
      </div>
      <div class="stat-value">{{ stats.totalRegistrations | number }}</div>
      <div class="stat-title">{{ 'adminAgents.stats.totalRegistrations' | translate }}</div>
      <div class="stat-change" [class.positive]="stats.registrationChangePercent >= 0" [class.negative]="stats.registrationChangePercent < 0">
        <span *ngIf="stats.registrationChangePercent >= 0">+</span>{{ stats.registrationChangePercent }}% {{ 'adminAgents.stats.fromLastMonth' | translate }}
      </div>
    </div>

    <!-- Active Agents Card -->
    <div class="stat-card">
      <div class="stat-header">
        <div class="stat-icon active-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
          </svg>
        </div>
        <span class="stat-label">{{ selectedAdminLabel }}</span>
      </div>
      <div class="stat-value">{{ stats.activeAgents }}</div>
      <div class="stat-title">{{ 'adminAgents.stats.activeAgents' | translate }}</div>
      <div class="stat-change neutral">
        {{ stats.operatingRate }}% {{ 'adminAgents.stats.operatingRate' | translate }}
      </div>
    </div>

    <!-- Inactive Agents Card -->
    <div class="stat-card">
      <div class="stat-header">
        <div class="stat-icon inactive-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
        </div>
        <span class="stat-label">{{ selectedAdminLabel }}</span>
      </div>
      <div class="stat-value">{{ stats.inactiveAgents }}</div>
      <div class="stat-title">{{ 'adminAgents.stats.inactiveAgents' | translate }}</div>
      <div class="stat-change attention" *ngIf="stats.inactiveAgents > 0">
        {{ 'adminAgents.stats.requiresAttention' | translate }}
      </div>
      <div class="stat-change neutral" *ngIf="stats.inactiveAgents === 0">
        {{ 'adminAgents.stats.allActive' | translate }}
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div class="loading-spinner" *ngIf="isLoading">
    <div class="spinner"></div>
  </div>

  <!-- Agents DataGrid -->
  <div class="table-card" *ngIf="!isLoading">
    <dx-data-grid
      [dataSource]="agents"
      [showBorders]="false"
      [rowAlternationEnabled]="true"
      [hoverStateEnabled]="true"
      [allowColumnResizing]="true"
      [columnAutoWidth]="true"
      [showColumnLines]="false"
      [showRowLines]="false"
      (onToolbarPreparing)="onToolbarPreparing($event)"
      (onExporting)="coreService.onExporting($event,'Agents.xlsx')"
      >
      
      <!-- Search and Filter -->
      <dxo-search-panel [visible]="true" [placeholder]="'adminAgents.searchPlaceholder' | translate"></dxo-search-panel>
      <dxo-export [enabled]="true"  [allowExportSelectedData]="false"></dxo-export>
      <!-- Paging -->
      <dxo-paging [pageSize]="10"></dxo-paging>
      <dxo-pager
            [showPageSizeSelector]="true"
        [allowedPageSizes]="[10, 20, 50, 100]"
        [showInfo]="true">
      </dxo-pager>

      <!-- Columns -->
      <dxi-column 
        dataField="name" 
        [caption]="'adminAgents.table.name' | translate"
        cellTemplate="nameTemplate"
        >
      </dxi-column>
      
      <dxi-column 
        dataField="username" 
        [caption]="'adminAgents.table.username' | translate"
      >
      </dxi-column>
      
      <dxi-column 
        dataField="promo_code" 
        [caption]="'adminAgents.table.promoCode' | translate"
        cellTemplate="promoCodeTemplate"
  >
      </dxi-column>
      
      <dxi-column 
        dataField="phone" 
        [caption]="'adminAgents.table.phone' | translate"
        cellTemplate="phoneTemplate"
       >
      </dxi-column>
      
      <dxi-column 
        dataField="registration_count" 
        [caption]="'adminAgents.table.registrations' | translate"
        dataType="number"
        sortOrder="desc">
      </dxi-column>

      <!-- Admin Name Column (SuperAdmin only) -->
      <dxi-column 
        *ngIf="isSuperAdmin"
        dataField="admin_name" 
        [caption]="'adminAgents.table.admin' | translate"
        cellTemplate="adminNameTemplate">
      </dxi-column>
      
      <dxi-column 
        dataField="status" 
        [caption]="'adminAgents.table.status' | translate"
        cellTemplate="statusTemplate"
        >
        <dxo-header-filter [dataSource]="statusFilterData"></dxo-header-filter>
      </dxi-column>
      
      <dxi-column 
        dataField="last_login" 
        [caption]="'adminAgents.table.lastLogin' | translate"
        dataType="datetime"
        cellTemplate="lastLoginTemplate"
   >
      </dxi-column>
      
      <dxi-column 
        [caption]="'adminAgents.table.actions' | translate"
        cellTemplate="actionsTemplate"
        [width]="120">
      </dxi-column>

      <!-- Cell Templates -->
      <div *dxTemplate="let data of 'nameTemplate'">
        <div class="agent-name">
          <div class="agent-avatar">{{ getInitial(data.value) }}</div>
          <span>{{ data.value || '(No Name)' }}</span>
        </div>
      </div>

      <div *dxTemplate="let data of 'promoCodeTemplate'">
        <span class="promo-code">{{ data.value }}</span>
      </div>

      <div *dxTemplate="let data of 'phoneTemplate'">
        {{ data.value || '-' }}
      </div>

      <div *dxTemplate="let data of 'adminNameTemplate'">
        <span class="admin-badge">{{ data.value || '-' }}</span>
      </div>

      <div *dxTemplate="let data of 'statusTemplate'">
        <span class="status-badge" [class.active]="data.value === 'active'" [class.inactive]="data.value === 'inactive'">
          {{ ('adminAgents.' + data.value) | translate }}
        </span>
      </div>

      <div *dxTemplate="let data of 'lastLoginTemplate'">
        {{ data.value ? (data.value | date:'short') : '-' }}
      </div>

      <div *dxTemplate="let data of 'actionsTemplate'">
        <button 
          class="btn-toggle" 
          [class.deactivate]="data.data.status === 'active'"
          [class.activate]="data.data.status === 'inactive'"
          (click)="toggleAgentStatus(data.data)">
          {{ (data.data.status === 'active' ? 'adminAgents.deactivate' : 'adminAgents.activate') | translate }}
        </button>
      </div>
    </dx-data-grid>
  </div>
</div>
