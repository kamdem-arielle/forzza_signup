<div class="agents-container">
  <div class="page-header">
    <div class="header-content">
      <div class="header-text">
        <h2>{{ 'adminNav.agents' | translate }}</h2>
        <p class="page-subtitle">{{ 'adminAgents.subtitle' | translate }}</p>
      </div>
      <button class="btn-create-agent" (click)="openCreateAgentModal()">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        {{ 'adminAgents.createAgent' | translate }}
      </button>
    </div>
  </div>

  <div *ngIf="message" class="message" [class.success]="isSuccess" [class.error]="!isSuccess">
    {{ message }}
  </div>

  <!-- Admin Filter (SuperAdmin only) -->
  <div class="filter-bar" *ngIf="isSuperAdmin">
    <div class="filter-group">
      <label>{{ 'filters.admin' | translate }}</label>
      <select class="styled-select" [(ngModel)]="selectedAdminId" (ngModelChange)="onAdminFilterChange()">
        <option [ngValue]="null">{{ 'filters.allAdmins' | translate }}</option>
        <option *ngFor="let admin of admins" [ngValue]="admin.id">{{ admin.username }}</option>
      </select>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="stats-cards" *ngIf="!isLoading">
    <!-- Total Agents Card -->
    <div class="stat-card">
      <div class="stat-header">
        <div class="stat-icon agents-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
          </svg>
        </div>
        <span class="stat-label">{{ selectedAdminLabel }}</span>
      </div>
      <div class="stat-value">{{ stats.totalAgents }}</div>
      <div class="stat-title">{{ 'adminAgents.stats.totalAgents' | translate }}</div>
      <div class="stat-change" [class.positive]="stats.agentChangePercent >= 0" [class.negative]="stats.agentChangePercent < 0">
        <span *ngIf="stats.agentChangePercent >= 0">+</span>{{ stats.agentChangePercent }}% {{ 'adminAgents.stats.fromLastMonth' | translate }}
      </div>
    </div>

    <!-- Total Registrations Card -->
    <div class="stat-card">
      <div class="stat-header">
        <div class="stat-icon registrations-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
            <polyline points="17 6 23 6 23 12"></polyline>
          </svg>
        </div>
        <span class="stat-label">{{ selectedAdminLabel }}</span>
      </div>
      <div class="stat-value">{{ stats.totalRegistrations | number }}</div>
      <div class="stat-title">{{ 'adminAgents.stats.totalRegistrations' | translate }}</div>
      <div class="stat-change" [class.positive]="stats.registrationChangePercent >= 0" [class.negative]="stats.registrationChangePercent < 0">
        <span *ngIf="stats.registrationChangePercent >= 0">+</span>{{ stats.registrationChangePercent }}% {{ 'adminAgents.stats.fromLastMonth' | translate }}
      </div>
    </div>

    <!-- Active Agents Card -->
    <div class="stat-card">
      <div class="stat-header">
        <div class="stat-icon active-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
          </svg>
        </div>
        <span class="stat-label">{{ selectedAdminLabel }}</span>
      </div>
      <div class="stat-value">{{ stats.activeAgents }}</div>
      <div class="stat-title">{{ 'adminAgents.stats.activeAgents' | translate }}</div>
      <div class="stat-change neutral">
        {{ stats.operatingRate }}% {{ 'adminAgents.stats.operatingRate' | translate }}
      </div>
    </div>

    <!-- Inactive Agents Card -->
    <div class="stat-card">
      <div class="stat-header">
        <div class="stat-icon inactive-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
        </div>
        <span class="stat-label">{{ selectedAdminLabel }}</span>
      </div>
      <div class="stat-value">{{ stats.inactiveAgents }}</div>
      <div class="stat-title">{{ 'adminAgents.stats.inactiveAgents' | translate }}</div>
      <div class="stat-change attention" *ngIf="stats.inactiveAgents > 0">
        {{ 'adminAgents.stats.requiresAttention' | translate }}
      </div>
      <div class="stat-change neutral" *ngIf="stats.inactiveAgents === 0">
        {{ 'adminAgents.stats.allActive' | translate }}
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div class="loading-spinner" *ngIf="isLoading">
    <div class="spinner"></div>
  </div>

  <!-- Agents DataGrid -->
  <div class="table-card" *ngIf="!isLoading">
    <dx-data-grid
      [dataSource]="agents"
      [showBorders]="false"
      [rowAlternationEnabled]="true"
      [hoverStateEnabled]="true"
      [allowColumnResizing]="true"
      [columnAutoWidth]="true"
      [showColumnLines]="false"
      [showRowLines]="false"
      (onToolbarPreparing)="onToolbarPreparing($event)"
      (onExporting)="coreService.onExporting($event,'Agents.xlsx')"
      >
      
      <!-- Search and Filter -->
      <dxo-search-panel [visible]="true" [placeholder]="'adminAgents.searchPlaceholder' | translate"></dxo-search-panel>
      <dxo-export [enabled]="true"  [allowExportSelectedData]="false"></dxo-export>
      <!-- Paging -->
      <dxo-paging [pageSize]="10"></dxo-paging>
      <dxo-pager
            [showPageSizeSelector]="true"
        [allowedPageSizes]="[10, 20, 50, 100]"
        [showInfo]="true">
      </dxo-pager>

      <!-- Columns -->
      <dxi-column 
        dataField="name" 
        [caption]="'adminAgents.table.name' | translate"
        cellTemplate="nameTemplate"
        >
      </dxi-column>
      
      <dxi-column 
        dataField="username" 
        [caption]="'adminAgents.table.username' | translate"
      >
      </dxi-column>
      
      <dxi-column 
        dataField="promo_code" 
        [caption]="'adminAgents.table.promoCode' | translate"
        cellTemplate="promoCodeTemplate"
  >
      </dxi-column>
      
      <dxi-column 
        dataField="phone" 
        [caption]="'adminAgents.table.phone' | translate"
        cellTemplate="phoneTemplate"
       >
      </dxi-column>
      
      <dxi-column 
        dataField="registration_count" 
        [caption]="'adminAgents.table.registrations' | translate"
        dataType="number"
        sortOrder="desc">
      </dxi-column>

      <!-- Admin Name Column (SuperAdmin only) -->
      <dxi-column 
        *ngIf="isSuperAdmin"
        dataField="admin_name" 
        [caption]="'adminAgents.table.admin' | translate"
        cellTemplate="adminNameTemplate">
      </dxi-column>
      
      <dxi-column 
        dataField="status" 
        [caption]="'adminAgents.table.status' | translate"
        cellTemplate="statusTemplate"
        >
        <dxo-header-filter [dataSource]="statusFilterData"></dxo-header-filter>
      </dxi-column>
      
      <dxi-column 
        dataField="last_login" 
        [caption]="'adminAgents.table.lastLogin' | translate"
        dataType="datetime"
        cellTemplate="lastLoginTemplate"
   >
      </dxi-column>
      
      <dxi-column 
        [caption]="'adminAgents.table.actions' | translate"
        cellTemplate="actionsTemplate"
        >
      </dxi-column>

      <!-- Cell Templates -->
      <div *dxTemplate="let data of 'nameTemplate'">
        <div class="agent-name">
          <div class="agent-avatar">{{ getInitial(data.value) }}</div>
          <span>{{ data.value || '(No Name)' }}</span>
        </div>
      </div>

      <div *dxTemplate="let data of 'promoCodeTemplate'">
        <span class="promo-code">{{ data.value }}</span>
      </div>

      <div *dxTemplate="let data of 'phoneTemplate'">
        {{ data.value || '-' }}
      </div>

      <div *dxTemplate="let data of 'adminNameTemplate'">
        <span class="admin-badge">{{ data.value || '-' }}</span>
      </div>

      <div *dxTemplate="let data of 'statusTemplate'">
        <span class="status-badge" [class.active]="data.value === 'active'" [class.inactive]="data.value === 'inactive'">
          {{ ('adminAgents.' + data.value) | translate }}
        </span>
      </div>

      <div *dxTemplate="let data of 'lastLoginTemplate'">
        {{ data.value ? (data.value | date:'short') : '-' }}
      </div>

      <div *dxTemplate="let data of 'actionsTemplate'">
        <div class="actions-cell">
          <button 
            class="btn-toggle" 
            [class.deactivate]="data.data.status === 'active'"
            [class.activate]="data.data.status === 'inactive'"
            (click)="toggleAgentStatus(data.data)">
            {{ (data.data.status === 'active' ? 'adminAgents.deactivate' : 'adminAgents.activate') | translate }}
          </button>
            <button 
            class="btn-action btn-qr" 
            title="Download QR Code"
            (click)="downloadQRCode(data.data)"
            *ngIf="data.data.qr_code">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="3" width="7" height="7"></rect>
              <rect x="14" y="3" width="7" height="7"></rect>
              <rect x="14" y="14" width="7" height="7"></rect>
              <rect x="3" y="14" width="7" height="7"></rect>
            </svg>
          </button>
          <button 
            class="btn-action btn-details" 
            title="Download Details"
            (click)="downloadDetails(data.data)"
            *ngIf="data.data.qr_code">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
          </button>
        </div>
      </div>
    </dx-data-grid>
  </div>
</div>

<!-- Create Agent Modal -->
<ng-template #createAgentModal let-modal>
  <div class="modal-header">
    <h4 class="modal-title">{{ 'adminAgents.createModal.title' | translate }}</h4>
    <button type="button" class="btn-close" (click)="closeModal()"></button>
  </div>
  <div class="modal-body">
    <!-- Tabs -->
    <div class="modal-tabs">
      <button class="tab-btn" [class.active]="activeTab === 'single'" (click)="switchTab('single')">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
        {{ 'adminAgents.createModal.singleAgent' | translate }}
      </button>
      <button class="tab-btn" [class.active]="activeTab === 'bulk'" (click)="switchTab('bulk')">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
          <circle cx="9" cy="7" r="4"></circle>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
          <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
        </svg>
        {{ 'adminAgents.createModal.bulkUpload' | translate }}
      </button>
    </div>

    <!-- Single Agent Form -->
    <form class="create-agent-form" [formGroup]="createAgentForm" *ngIf="activeTab === 'single'">
      <div class="form-row">
        <div class="form-group">
          <label>{{ 'adminAgents.createModal.firstName' | translate }} <span class="text-danger">*</span> </label>
          <input type="text" formControlName="surname" class="form-control" [class.is-invalid]="isFieldInvalid('surname')">
          <div class="field-error" *ngIf="hasError('surname', 'required')">
            {{ 'adminAgents.createModal.errors.surnameRequired' | translate }}
          </div>
          <div class="field-error" *ngIf="hasError('surname', 'minlength')">
            {{ 'adminAgents.createModal.errors.surnameMinLength' | translate }}
          </div>
        </div>
        <div class="form-group">
          <label>{{ 'adminAgents.createModal.lastName' | translate }} <span class="text-danger">*</span></label>
          <input type="text" formControlName="lastname" class="form-control" [class.is-invalid]="isFieldInvalid('lastname')">
          <div class="field-error" *ngIf="hasError('lastname', 'required')">
            {{ 'adminAgents.createModal.errors.lastnameRequired' | translate }}
          </div>
          <div class="field-error" *ngIf="hasError('lastname', 'minlength')">
            {{ 'adminAgents.createModal.errors.lastnameMinLength' | translate }}
          </div>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>{{ 'adminAgents.createModal.phone' | translate }} <span class="text-danger">*</span></label>
          <input type="tel" formControlName="phone" class="form-control" [class.is-invalid]="isFieldInvalid('phone')" placeholder="6XXXXXXXX">
          <div class="field-error" *ngIf="hasError('phone', 'required')">
            {{ 'adminAgents.createModal.errors.phoneRequired' | translate }}
          </div>
          <div class="field-error" *ngIf="hasError('phone', 'invalidCameroonPhone')">
            {{ 'adminAgents.createModal.errors.phoneInvalid' | translate }}
          </div>
        </div>
        <div class="form-group">
          <label>{{ 'adminAgents.createModal.email' | translate }}</label>
          <input type="email" formControlName="email" class="form-control" [class.is-invalid]="isFieldInvalid('email')">
          <div class="field-error" *ngIf="hasError('email', 'email')">
            {{ 'adminAgents.createModal.errors.emailInvalid' | translate }}
          </div>
        </div> 
      </div>

      <div class="form-group">
        <label>{{ 'adminAgents.createModal.city' | translate }} <span class="text-danger">*</span></label>
        <input type="text" formControlName="city" class="form-control" [class.is-invalid]="isFieldInvalid('city')">
        <div class="field-error" *ngIf="hasError('city', 'required')">
          {{ 'adminAgents.createModal.errors.cityRequired' | translate }}
        </div>
      </div>

      <div class="form-group" *ngIf="isSuperAdmin">
        <label>{{ 'adminAgents.createModal.assignAdmin' | translate }} <span class="text-danger">*</span></label>
        <select formControlName="admin_id" class="form-control form-select" [class.is-invalid]="isFieldInvalid('admin_id')">
          <option [ngValue]="null" disabled>{{ 'adminAgents.createModal.selectAdminPlaceholder' | translate }}</option>
          <option *ngFor="let admin of admins" [ngValue]="admin.id">{{ admin.username }}</option>
        </select>
        <div class="field-error" *ngIf="hasError('admin_id', 'required')">
          {{ 'adminAgents.createModal.errors.adminRequired' | translate }}
        </div>
      </div>
    </form>

    <!-- Bulk Upload Section -->
    <div class="bulk-upload-section" *ngIf="activeTab === 'bulk'">
      <!-- Admin Selection for SuperAdmin -->
      <div class="form-group admin-select-group" *ngIf="isSuperAdmin">
        <label>{{ 'adminAgents.createModal.assignAdmin' | translate }} <span class="text-danger">*</span></label>
        <select [(ngModel)]="bulkAdminId" class="form-control form-select">
          <option [ngValue]="null">{{ 'adminAgents.createModal.selectAdminPlaceholder' | translate }}</option>
          <option *ngFor="let admin of admins" [ngValue]="admin.id">{{ admin.username }}</option>
        </select>
        <div class="field-hint" *ngIf="!bulkAdminId">
          {{ 'adminAgents.bulkUpload.selectAdminForTemplate' | translate }}
        </div>
      </div>
      
      <div class="file-upload-zone" 
           [class.drag-over]="isDragOver"
           [class.has-file]="selectedFile"
           (dragover)="onDragOver($event)"
           (dragleave)="onDragLeave($event)"
           (drop)="onDrop($event)">
        <div class="upload-content" *ngIf="!selectedFile">
          <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
          </svg>
          <p>{{ 'adminAgents.bulkUpload.dragDrop' | translate }}</p>
          <span class="or-text">{{ 'adminAgents.bulkUpload.or' | translate }}</span>
          <label class="btn-browse">
            {{ 'adminAgents.bulkUpload.browse' | translate }}
            <input type="file" accept=".xlsx,.xls" (change)="onFileSelected($event)" hidden>
          </label>
        </div>
        <div class="file-selected" *ngIf="selectedFile">
          <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
          </svg>
          <div class="file-info">
            <span class="file-name">{{ selectedFile.name }}</span>
            <span class="file-size">{{ formatFileSize(selectedFile.size) }}</span>
          </div>
          <button class="btn-remove-file" (click)="removeSelectedFile()">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
      </div>

      <!-- Download Template & Format Info -->
      <div class="template-row">
        <button class="btn-download-template" 
                (click)="downloadTemplate()"
                [disabled]="isSuperAdmin && !bulkAdminId"
                [class.disabled]="isSuperAdmin && !bulkAdminId">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
          {{ 'adminAgents.bulkUpload.downloadTemplate' | translate }}
        </button>
        <span class="format-info">{{ 'adminAgents.bulkUpload.supportedFormats' | translate }}: .xlsx, .xls</span>
      </div>

      <!-- Bulk Upload Error -->
      <div class="bulk-error" *ngIf="bulkUploadError">
        {{ bulkUploadError }}
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="closeModal()">{{ 'common.cancel' | translate }}</button>
    
    <!-- Single Agent Submit -->
    <button type="button" class="btn btn-primary" (click)="createAgent()" 
            *ngIf="activeTab === 'single'"
            [disabled]="isCreating || createAgentForm.invalid"
            [class.btn-disabled]="createAgentForm.invalid">
      <span *ngIf="isCreating" class="spinner-small"></span>
      {{ 'adminAgents.createAgent' | translate }}
    </button>
    
    <!-- Bulk Upload Submit -->
    <button type="button" class="btn btn-primary" (click)="bulkCreateAgents()" 
            *ngIf="activeTab === 'bulk'"
            [disabled]="isCreating || !selectedFile"
            [class.btn-disabled]="!selectedFile">
      <span *ngIf="isCreating" class="spinner-small"></span>
      {{ 'adminAgents.bulkUpload.createAgents' | translate }}
    </button>
  </div>
</ng-template>

<!-- Success Modal -->
<ng-template #successModal let-modal>
  <div class="modal-header">
    <h4 class="modal-title" *ngIf="!isBulkSuccess">{{ 'adminAgents.successModal.title' | translate }}</h4>
    <h4 class="modal-title" *ngIf="isBulkSuccess">{{ bulkResults?.summary?.successful }} {{ 'adminAgents.bulkUpload.successful' | translate }}</h4>
    <button type="button" class="btn-close" (click)="closeModal()"></button>
  </div>
  <div class="modal-body success-modal-body">
    <!-- Success Icon -->
    <div class="success-icon">
      <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
        <polyline points="22 4 12 14.01 9 11.01"></polyline>
      </svg>
    </div>
    
    <!-- Single Agent Success Message -->
    <p class="success-message" *ngIf="!isBulkSuccess">{{ 'adminAgents.successModal.message' | translate }}</p>
    
    <!-- Bulk Success Message -->
    <p class="success-message" *ngIf="isBulkSuccess">
      {{ bulkResults?.summary?.successful }} agents have been successfully created. You can search, filter, and download their credentials below.
    </p>

    <!-- Single Agent Details Card -->
    <div class="agent-details-card" *ngIf="!isBulkSuccess && createdAgent">
      <div class="agent-qr">
        <img [src]="createdAgent.qr_code" alt="QR Code" class="qr-image">
      </div>
      <div class="agent-info">
        <h5 class="agent-name">{{ createdAgent.name }}</h5>
        <div class="promo-badge">{{ createdAgent.promo_code }}</div>
        <span class="promo-label">{{ 'adminAgents.successModal.promoCode' | translate }}</span>
        <div class="agent-url-container">
          <input type="text" [value]="createdAgent.agent_url" readonly class="url-input">
          <button class="btn-copy" (click)="copyToClipboard(createdAgent.agent_url)" title="Copy URL">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
          </button>
        </div>
      </div>
      <div class="agent-actions">
        <button class="btn-download" (click)="downloadQRCode(createdAgent)">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
          {{ 'adminAgents.successModal.qrCode' | translate }}
        </button>
        <button class="btn-download" (click)="downloadDetails(createdAgent)">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
          </svg>
          {{ 'adminAgents.successModal.details' | translate }}
        </button>
      </div>
    </div>

    <!-- Bulk Results Section -->
    <div class="bulk-results-section" *ngIf="isBulkSuccess && bulkResults">
      <!-- Export Button -->
      <div class="bulk-results-toolbar">
        <button class="btn-export" (click)="downloadAllBulk()">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
          Export All
        </button>
      </div>

      <!-- Bulk Results DevExtreme DataGrid -->
      <div class="bulk-results-grid-container">
        <dx-data-grid
          [dataSource]="bulkResultsDataSource"
          [showBorders]="false"
          [rowAlternationEnabled]="true"
          [hoverStateEnabled]="true"
          [columnAutoWidth]="true"
          [showColumnLines]="false"
          [showRowLines]="false"
          height="300">
          
          <!-- Search -->
          <dxo-search-panel [visible]="true" placeholder="Search agents..."></dxo-search-panel>
          
          <!-- Paging -->
          <dxo-paging [pageSize]="10"></dxo-paging>
          <dxo-pager
            [showPageSizeSelector]="true"
            [allowedPageSizes]="[10, 25, 50]"
            [showInfo]="true">
          </dxo-pager>

          <!-- Columns -->
          <dxi-column 
            dataField="name" 
            [caption]="'adminAgents.columns.fullName' | translate">
          </dxi-column>
          
          <dxi-column 
            dataField="promo_code" 
            [caption]="'adminAgents.columns.promoCode' | translate"
            cellTemplate="bulkPromoCodeTemplate">
          </dxi-column>
          
          <dxi-column 
            dataField="agent_url" 
            [caption]="'adminAgents.columns.signupLink' | translate"
            cellTemplate="bulkUrlTemplate">
          </dxi-column>
          
          <dxi-column 
            dataField="phone" 
            [caption]="'adminAgents.columns.phone' | translate">
          </dxi-column>
          
          <dxi-column 
            dataField="city" 
            [caption]="'adminAgents.columns.city' | translate">
          </dxi-column>
          
          <dxi-column 
            [caption]="'common.actions' | translate"
            cellTemplate="bulkActionsTemplate"
            [width]="100"
            [allowSorting]="false"
            [allowFiltering]="false">
          </dxi-column>

          <!-- Cell Templates -->
          <div *dxTemplate="let data of 'bulkPromoCodeTemplate'">
            <span class="promo-badge-small">{{ data.value }}</span>
          </div>

          <div *dxTemplate="let data of 'bulkUrlTemplate'">
            <div class="url-cell">
              <input type="text" [value]="data.value" readonly class="url-input-small">
              <button class="btn-copy-small" (click)="copyToClipboard(data.value)" title="Copy URL">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                  <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
              </button>
            </div>
          </div>

          <div *dxTemplate="let data of 'bulkActionsTemplate'">
            <div class="action-buttons">
              <button class="btn-action" (click)="downloadQRCode(data.data)" title="Download QR Code">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="3" y="3" width="7" height="7"></rect>
                  <rect x="14" y="3" width="7" height="7"></rect>
                  <rect x="14" y="14" width="7" height="7"></rect>
                  <rect x="3" y="14" width="7" height="7"></rect>
                </svg>
              </button>
              <button class="btn-action" (click)="downloadDetails(data.data)" title="Download Details">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="7 10 12 15 17 10"></polyline>
                  <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
              </button>
            </div>
          </div>
        </dx-data-grid>
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="closeModal()">{{ 'common.close' | translate }}</button>
    <button type="button" class="btn btn-primary" *ngIf="!isBulkSuccess" (click)="downloadAll()">{{ 'adminAgents.successModal.downloadAll' | translate }}</button>
  </div>
</ng-template>
