<div class="agents-container">
  <div class="page-header">
    <h2>{{ 'adminNav.agents' | translate }}</h2>
    <p class="page-subtitle">{{ 'adminAgents.subtitle' | translate }}</p>
  </div>

  <div *ngIf="message" class="message" [class.success]="isSuccess" [class.error]="!isSuccess">
    {{ message }}
  </div>

  <!-- Loading -->
  <div class="loading-spinner" *ngIf="isLoading">
    <div class="spinner"></div>
  </div>

  <!-- Agents DataGrid -->
  <div class="table-card" *ngIf="!isLoading">
    <dx-data-grid
      [dataSource]="agents"
      [showBorders]="false"
      [rowAlternationEnabled]="true"
      [hoverStateEnabled]="true"
      [allowColumnResizing]="true"
      [columnAutoWidth]="true"
      [showColumnLines]="false"
      [showRowLines]="false"
      (onToolbarPreparing)="onToolbarPreparing($event)">
      
      <!-- Search and Filter -->
      <dxo-search-panel [visible]="true" [placeholder]="'adminAgents.searchPlaceholder' | translate"></dxo-search-panel>
      
      <!-- Paging -->
      <dxo-paging [pageSize]="10"></dxo-paging>
      <dxo-pager
            [showPageSizeSelector]="true"
        [allowedPageSizes]="[10, 20, 50, 100]"
        [showInfo]="true">
      </dxo-pager>

      <!-- Columns -->
      <dxi-column 
        dataField="name" 
        [caption]="'adminAgents.table.name' | translate"
        cellTemplate="nameTemplate"
        >
      </dxi-column>
      
      <dxi-column 
        dataField="username" 
        [caption]="'adminAgents.table.username' | translate"
      >
      </dxi-column>
      
      <dxi-column 
        dataField="promo_code" 
        [caption]="'adminAgents.table.promoCode' | translate"
        cellTemplate="promoCodeTemplate"
  >
      </dxi-column>
      
      <dxi-column 
        dataField="phone" 
        [caption]="'adminAgents.table.phone' | translate"
        cellTemplate="phoneTemplate"
       >
      </dxi-column>
      
      <dxi-column 
        dataField="registration_count" 
        [caption]="'adminAgents.table.registrations' | translate"
        dataType="number"
        sortOrder="desc">
      </dxi-column>
      
      <dxi-column 
        dataField="status" 
        [caption]="'adminAgents.table.status' | translate"
        cellTemplate="statusTemplate"
        >
        <dxo-header-filter [dataSource]="statusFilterData"></dxo-header-filter>
      </dxi-column>
      
      <dxi-column 
        dataField="last_login" 
        [caption]="'adminAgents.table.lastLogin' | translate"
        dataType="datetime"
        cellTemplate="lastLoginTemplate"
   >
      </dxi-column>
      
      <dxi-column 
        [caption]="'adminAgents.table.actions' | translate"
        cellTemplate="actionsTemplate"
        [width]="120">
      </dxi-column>

      <!-- Cell Templates -->
      <div *dxTemplate="let data of 'nameTemplate'">
        <div class="agent-name">
          <div class="agent-avatar">{{ getInitial(data.value) }}</div>
          <span>{{ data.value || '(No Name)' }}</span>
        </div>
      </div>

      <div *dxTemplate="let data of 'promoCodeTemplate'">
        <span class="promo-code">{{ data.value }}</span>
      </div>

      <div *dxTemplate="let data of 'phoneTemplate'">
        {{ data.value || '-' }}
      </div>

      <div *dxTemplate="let data of 'statusTemplate'">
        <span class="status-badge" [class.active]="data.value === 'active'" [class.inactive]="data.value === 'inactive'">
          {{ ('adminAgents.' + data.value) | translate }}
        </span>
      </div>

      <div *dxTemplate="let data of 'lastLoginTemplate'">
        {{ data.value ? (data.value | date:'short') : '-' }}
      </div>

      <div *dxTemplate="let data of 'actionsTemplate'">
        <button 
          class="btn-toggle" 
          [class.deactivate]="data.data.status === 'active'"
          [class.activate]="data.data.status === 'inactive'"
          (click)="toggleAgentStatus(data.data)">
          {{ (data.data.status === 'active' ? 'adminAgents.deactivate' : 'adminAgents.activate') | translate }}
        </button>
      </div>
    </dx-data-grid>
  </div>
</div>
